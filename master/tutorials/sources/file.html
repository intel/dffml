

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Simple source for new file types &mdash; DFFML cab834974 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Example SQLite source" href="complex.html" />
    <link rel="prev" title="Sources" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> DFFML
          

          
          </a>

          
            
            
              <div class="version">
                cab834974
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/index.html">Concepts</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/model.html">Quickstart</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../models/index.html">Models</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Sources</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Simple source for new file types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create-the-package">Create the Package</a></li>
<li class="toctree-l4"><a class="reference internal" href="#about-ini-files">About INI files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#import-modules">Import modules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-configuration">Add configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-source">Create Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-load-method">Add load method</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-dump-method">Add dump method</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-tests">Add Tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-the-tests">Run the tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-the-entrypoint">Add the entrypoint</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-your-package">Install your package</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cli-usage">CLI Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="complex.html">Example SQLite source</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../accuracy/index.html">Scorers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dataflows/index.html">DataFlows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../neuralnetwork.html">Neural Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../doublecontextentry.html">Double Context Entry</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/service/http/index.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/noasync.html">Noasync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/base.html">Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/record.html">Record</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/log.html">Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/high_level.html">High_Level</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/version.html">Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/source/index.html">Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/operation/index.html">Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/feature/index.html">Feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/accuracy/index.html">Accuracy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/cli/index.html">Cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/secret/index.html">Secret</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/df/index.html">Df</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/db/index.html">Db</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/service/index.html">Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/configloader/index.html">Configloader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/model/index.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/util/index.html">Util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/port/index.html">Port</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arch/index.html">Architecture</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Subprojects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../shouldi.html">shouldi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../swportal.html">Software Portal</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/dffml">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://intel.github.io/dffml/master/">Master Branch Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact Us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../news/index.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DFFML</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Tutorials</a> &raquo;</li>
        
          <li><a href="index.html">Sources</a> &raquo;</li>
        
      <li>Simple source for new file types</li>
    
    


      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/intel/dffml/blob/master/docs/tutorials/sources/file.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    


  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="simple-source-for-new-file-types">
<h1>Simple source for new file types<a class="headerlink" href="#simple-source-for-new-file-types" title="Permalink to this headline">¶</a></h1>
<p>This tutorial will help you with implementing your own <code class="docutils literal notranslate"><span class="pre">Source</span></code> for new file
types. You may want to do this if you have some specific file formats from which
you want to load and save data from.</p>
<p>Here we will go through implementing a source for <code class="docutils literal notranslate"><span class="pre">.ini</span></code> file formats.</p>
<div class="section" id="create-the-package">
<h2>Create the Package<a class="headerlink" href="#create-the-package" title="Permalink to this headline">¶</a></h2>
<p>To create a new source we first create a new Python package. DFFML has a script
to do it for you.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dffml service dev create <span class="nb">source</span> dffml-source-ini
<span class="gp">$ </span><span class="nb">cd</span> dffml-source-ini
</pre></div>
</div>
<p>We will start writing our source in ./dffml_source_ini/misc.py</p>
</div>
<div class="section" id="about-ini-files">
<h2>About INI files<a class="headerlink" href="#about-ini-files" title="Permalink to this headline">¶</a></h2>
<p>An INI file is a configuration file used by Operating Systems and programs
to initialize program settings. It contains sections for settings and preferences
(delimited by a string in square brackets) with each section containing one
or more name and value parameters.</p>
</div>
<div class="section" id="import-modules">
<h2>Import modules<a class="headerlink" href="#import-modules" title="Permalink to this headline">¶</a></h2>
<p><strong>dffml_source_ini/misc.py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>

<span class="kn">from</span> <span class="nn">dffml</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">,</span> <span class="n">Record</span><span class="p">,</span> <span class="n">FileSource</span><span class="p">,</span> <span class="n">MemorySource</span><span class="p">,</span> <span class="n">parser_helper</span>
</pre></div>
</div>
<p>Here we are importing some common modules which will be required. The <code class="docutils literal notranslate"><span class="pre">configparser</span></code>
module will be helpful in parsing INI files. The <code class="docutils literal notranslate"><span class="pre">FileSource</span></code> and <code class="docutils literal notranslate"><span class="pre">MemorySource</span></code>
will be used as base class for our new Source. The config was imported to set the
configuration options for our new INISource. The entrypoint will be used to add the
entrypoint to our INISource. A <code class="docutils literal notranslate"><span class="pre">Record</span></code> is a unique entry in a source.</p>
</div>
<div class="section" id="add-configuration">
<h2>Add configuration<a class="headerlink" href="#add-configuration" title="Permalink to this headline">¶</a></h2>
<p><strong>dffml_source_ini/misc.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@config</span>
<span class="k">class</span> <span class="nc">INISourceConfig</span><span class="p">:</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">readwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">allowempty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Here we will be writing the configuration options which will be avaliable for our
INISource. The INISourceConfig will be decorated by config. Here we have provided
three configuration options.</p>
</div>
<div class="section" id="create-source">
<h2>Create Source<a class="headerlink" href="#create-source" title="Permalink to this headline">¶</a></h2>
<p><strong>dffml_source_ini/misc.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@entrypoint</span><span class="p">(</span><span class="s2">&quot;ini&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">INISource</span><span class="p">(</span><span class="n">FileSource</span><span class="p">,</span> <span class="n">MemorySource</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Source to read files in .ini format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">INISourceConfig</span>
</pre></div>
</div>
<p>Here we have added the entrypoint to INISource class as “ini”. Do note that “ini” source
already exist in dffml list of sources, so you may want to call your own source as “myini”.
The new Source should inherit from FileSource and MemorySource as it abstracts the saving
and loading of files so that we only have to implement the load_fd and dump_fd methods.
It takes care of decompression on load and re-compression on save if the files extension
signifies that it’s compressed. We inherit from MemorySource because it implements the
methods required by a <a class="reference internal" href="../../api/source/source.html#dffml.source.source.BaseSourceContext" title="dffml.source.source.BaseSourceContext"><code class="xref py py-class docutils literal notranslate"><span class="pre">Source</span></code></a> provided
that self.mem contains Record objects.</p>
<p>Set the CONFIG variable to the INISourceConfig which we created earlier. Setting
the CONFIG variable is important because the instantiated version of CONFIG is accessible
as self.config.</p>
<p>Next we will writing the load and dump methods for INISource.</p>
</div>
<div class="section" id="add-load-method">
<h2>Add load method<a class="headerlink" href="#add-load-method" title="Permalink to this headline">¶</a></h2>
<p><strong>dffml_source_ini/misc.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">load_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
        <span class="c1"># Creating an instance of configparser</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="c1"># Read from a file object</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
        <span class="c1"># Get all the sections present in the file</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Go over each section</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="c1"># Get data under each section as a dict</span>
            <span class="n">temp_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
                <span class="n">temp_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser_helper</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="c1"># Each section used as a record</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">temp_dict</span><span class="p">}</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> loaded </span><span class="si">%d</span><span class="s2"> sections&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">))</span>
</pre></div>
</div>
<p>This method will be used to load the data from the file(s). We will be reading data
from the file object (fileobj) and loading that data into memory (self.mem). Each
<a class="reference internal" href="../../api/record.html#dffml.record.Record" title="dffml.record.Record"><code class="xref py py-class docutils literal notranslate"><span class="pre">Record</span></code></a> instance consist of key (str type) of the
record and data (dict type), with data having a key <code class="docutils literal notranslate"><span class="pre">features</span></code> which stores all
the data for that record.</p>
<p>Going over the code, we have defined a coroutine with parameter fileobj, here
fileobj is the file object. we are reading from the fileobj file object. Each section of the
INI file is used as a Record, with the name of the section used as key for that Record.
Each section consists of key value pairs stored as a dict. We’re going to treat
this data as the feature data for each Record. To do so we pass the data as
the value for the <code class="docutils literal notranslate"><span class="pre">features</span></code> key under the <code class="docutils literal notranslate"><span class="pre">data</span></code> keyword argument when
creating a new Record.</p>
</div>
<div class="section" id="add-dump-method">
<h2>Add dump method<a class="headerlink" href="#add-dump-method" title="Permalink to this headline">¶</a></h2>
<p><strong>dffml_source_ini/misc.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">dump_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
        <span class="c1"># Create an instance of configparser</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>

        <span class="c1"># Go over each section and record in mem</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Get each section data as a dict</span>
            <span class="n">section_data</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">features</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># If section does not exist add new section</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
            <span class="c1"># Set section data</span>
            <span class="n">parser</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="n">section_data</span>

        <span class="c1"># Write to the fileobject</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> saved </span><span class="si">%d</span><span class="s2"> sections&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">))</span>
</pre></div>
</div>
<p>This method will be used to dump the data to the file. We will read data from memory
(self.mem) and save that data in file object (fileobj).</p>
<p>Going over the code, we have defined a coroutine with parameter fileobj, here
fileobj is the file object. We are going over each section name and its corresponding Record.
We are reading all the data from the memory (self.mem) and writing that data to our file
object (fileobj). Hence dumping all our data into file.</p>
</div>
<div class="section" id="add-tests">
<h2>Add Tests<a class="headerlink" href="#add-tests" title="Permalink to this headline">¶</a></h2>
<p><strong>tests/test_source.py</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>

<span class="kn">from</span> <span class="nn">dffml</span> <span class="kn">import</span> <span class="n">Record</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">AsyncTestCase</span>

<span class="kn">from</span> <span class="nn">dffml_source_ini.misc</span> <span class="kn">import</span> <span class="n">INISource</span>
</pre></div>
</div>
<p>Before writing the test we need to import some modules which we will be using. We need
to import the source file which we created earlier. We need to import <code class="docutils literal notranslate"><span class="pre">save</span></code> and
<code class="docutils literal notranslate"><span class="pre">load</span></code> from high_level. save method will be used to save the records to the source and
load will be used to yield records from a source. AsyncTestCase will be used to run our
test methods as coroutines in default event loop.</p>
<p><strong>tests/test_source.py</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestINISource</span><span class="p">(</span><span class="n">AsyncTestCase</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_ini</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">testdir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;testfile.ini&quot;</span><span class="p">)</span>
            <span class="c1"># Create a source</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">INISource</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testfile</span><span class="p">,</span> <span class="n">allowempty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readwrite</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># Save some data in the source</span>
            <span class="k">await</span> <span class="n">save</span><span class="p">(</span>
                <span class="n">source</span><span class="p">,</span>
                <span class="n">Record</span><span class="p">(</span><span class="s2">&quot;section1&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}}),</span>
                <span class="n">Record</span><span class="p">(</span><span class="s2">&quot;section2&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}}),</span>
            <span class="p">)</span>
            <span class="c1"># Load all the records</span>
            <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span> <span class="k">async</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">load</span><span class="p">(</span><span class="n">source</span><span class="p">)]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
</pre></div>
</div>
<p>To test the working of the INISource created we will create a class TestINISource, since
we are using the unittest testing framework. The TestINISource will inherit from AsyncTestCase
so that it can be run as a coroutine in the default event loop. In the test method we will
create a TemporaryDirectory which will contain our <cite>.ini</cite> file.</p>
<p>We will create an instance of our INISource with configuration options. Next we will use
the save method to save some records to the source. Do not forget to await the save method
as it is a coroutine. Next we will use the load method to yield records from the source.
load method will return AsyncIterator[Record] type object. Lastly, We need to check that
the records we saved is the same record which gets loaded.</p>
</div>
<div class="section" id="run-the-tests">
<h2>Run the tests<a class="headerlink" href="#run-the-tests" title="Permalink to this headline">¶</a></h2>
<p>To run the tests</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python -m unittest discover -v
</pre></div>
</div>
<p>This will look into the file test_source.py and run all the tests.</p>
</div>
<div class="section" id="add-the-entrypoint">
<h2>Add the entrypoint<a class="headerlink" href="#add-the-entrypoint" title="Permalink to this headline">¶</a></h2>
<p>To register your source under dffml entrypoint you need to make sure you have a
<code class="docutils literal notranslate"><span class="pre">shorthand</span></code> equals <code class="docutils literal notranslate"><span class="pre">python.path.to:Class</span></code> line in the <code class="docutils literal notranslate"><span class="pre">entry_points.txt</span></code>
file.</p>
<p><strong>entry_points.txt</strong></p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[dffml.source]</span>
<span class="na">myini</span> <span class="o">=</span> <span class="s">dffml_source_ini.misc:INISource</span>
</pre></div>
</div>
<p>This will add the newly created source to the dffml entrypoints and hence can
also be used in CLI.</p>
</div>
<div class="section" id="install-your-package">
<h2>Install your package<a class="headerlink" href="#install-your-package" title="Permalink to this headline">¶</a></h2>
<p>To install your new source run</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python -m pip install -e .<span class="o">[</span>dev<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="cli-usage">
<h2>CLI Usage<a class="headerlink" href="#cli-usage" title="Permalink to this headline">¶</a></h2>
<p>Create a <code class="docutils literal notranslate"><span class="pre">.ini</span></code> file with some record data in it.</p>
<p><strong>data.ini</strong></p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[dffml]</span>
<span class="na">third_party</span> <span class="o">=</span> <span class="s">yes</span>
<span class="na">maintained</span> <span class="o">=</span> <span class="s">true</span>

<span class="k">[python]</span>
<span class="na">third_party</span> <span class="o">=</span> <span class="s">no</span>
<span class="na">maintained</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
<p>To use your newly created source in CLI, try listing some records.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dffml list records -sources <span class="nv">data</span><span class="o">=</span>myini -source-filename data.ini
<span class="go">[</span>
<span class="go">    {</span>
<span class="go">        &quot;extra&quot;: {},</span>
<span class="go">        &quot;features&quot;: {</span>
<span class="go">            &quot;maintained&quot;: true,</span>
<span class="go">            &quot;third_party&quot;: true</span>
<span class="go">        },</span>
<span class="go">        &quot;key&quot;: &quot;dffml&quot;</span>
<span class="go">    },</span>
<span class="go">    {</span>
<span class="go">        &quot;extra&quot;: {},</span>
<span class="go">        &quot;features&quot;: {</span>
<span class="go">            &quot;maintained&quot;: true,</span>
<span class="go">            &quot;third_party&quot;: false</span>
<span class="go">        },</span>
<span class="go">        &quot;key&quot;: &quot;python&quot;</span>
<span class="go">    }</span>
<span class="go">]</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="complex.html" class="btn btn-neutral float-right" title="Example SQLite source" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="Sources" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017 - 2021, Intel.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>