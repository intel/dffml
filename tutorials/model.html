

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>New Model Tutorial &mdash; DFFML 0.3.3 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="New Source Tutorial" href="source.html" />
    <link rel="prev" title="New Operations Tutorial" href="operations.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> DFFML
          

          
          </a>

          
            
            
              <div class="version">
                0.3.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart/model.html">Quickstart</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction to DFFML</a></li>
<li class="toctree-l2"><a class="reference internal" href="operations.html">New Operations Tutorial</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">New Model Tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-the-package">Create the Package</a></li>
<li class="toctree-l3"><a class="reference internal" href="#edit-the-model">Edit the model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#imports">Imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#class-name">Class Name</a></li>
<li class="toctree-l4"><a class="reference internal" href="#train">Train</a></li>
<li class="toctree-l4"><a class="reference internal" href="#accuracy">Accuracy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#predict">Predict</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#correct-the-plugin-load-path">Correct the plugin load path</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-the-new-model">Test the new model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#change-the-import-path">Change the import path</a></li>
<li class="toctree-l4"><a class="reference internal" href="#change-the-class-name">Change the class name</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-the-tests">Run the tests</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="source.html">New Source Tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage/index.html">Use Cases</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/service/http/index.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contact.html">Contact Us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DFFML</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Tutorials</a> &raquo;</li>
        
      <li>New Model Tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorials/model.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="new-model-tutorial">
<span id="model-tutorial"></span><h1>New Model Tutorial<a class="headerlink" href="#new-model-tutorial" title="Permalink to this headline">¶</a></h1>
<p>If you have some data and want to do machine learning on it, you probably want
to head over to the <a class="reference internal" href="../plugins/dffml_model.html#plugin-models"><span class="std std-ref">Models</span></a> plugins. This tutorial is for
implementing a machine learning algorithm. Which is probably what you want if
there’s not an existing plugin for your algorithm.</p>
<p>DFFML is not like PyTorch or TensorFlow. It’s higher level than those. However,
that doesn’t mean it <em>has</em> to be higher level. You can use the lower level APIs
of any library, or no library if you wanted.</p>
<p>For this tutorial we’ll be implementing our own machine learning algorithm from
scratch, which means that we’re not using a machine learning focused library to
handle calculations for us.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This tutorial needs updating. It will be updated to follow the way
the <a class="reference external" href="https://github.com/intel/dffml/blob/master/model/scratch/dffml_model_scratch/slr.py">scratch model</a>
works. For now you might want to skim through this, and then look at that as
a reference.</p>
</div>
<p>You’ll most likely want to use a popular machine learning framework eventually
within your model class. For an example on how one might use <code class="docutils literal notranslate"><span class="pre">scikit</span></code> see the
code for the <a class="reference external" href="https://github.com/intel/dffml/blob/master/model/scikit/dffml_model_scikit/scikit_base.py">scikit models</a>.</p>
<div class="section" id="create-the-package">
<h2>Create the Package<a class="headerlink" href="#create-the-package" title="Permalink to this headline">¶</a></h2>
<p>To create a new model we first create a new python package. DFFML has a script
to create it for you.</p>
<p>We’re going to create a model that matches a new record exactly to anything it’s
seen before. If it has seen it before it will be 100% confident. If it hasn’t
seen it before it’ll pick a random classification and assign that as it’s
prediction with a 0% confidence.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> dffml service dev create model my-model
</pre></div>
</div>
<p>This creates a Python package for you with a model that does nothing, called
<code class="docutils literal notranslate"><span class="pre">MiscModel</span></code>, and some useless tests.</p>
</div>
<div class="section" id="edit-the-model">
<h2>Edit the model<a class="headerlink" href="#edit-the-model" title="Permalink to this headline">¶</a></h2>
<p>Now we’ll go through the three methods of a <code class="docutils literal notranslate"><span class="pre">Model</span></code> and fill them out.</p>
<div class="section" id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h3>
<p>We’re going to need a few modules from the standard library, let’s import them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
</pre></div>
</div>
</div>
<div class="section" id="class-name">
<h3>Class Name<a class="headerlink" href="#class-name" title="Permalink to this headline">¶</a></h3>
<p>Let’s once again rename <code class="docutils literal notranslate"><span class="pre">Misc</span></code> to <code class="docutils literal notranslate"><span class="pre">Hindsight</span></code>, this time the class in the file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hindsight</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A model which matches a new record exactly to anything it&#39;s seen before. If it</span>
<span class="sd">    has seen it before it will be 100% confident. If it hasn&#39;t seen it before</span>
<span class="sd">    it&#39;ll pick a random classification and assign that as it&#39;s prediction with a</span>
<span class="sd">    0% confidence.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># We aren&#39;t worring about saving and loading our model in this tutorial.</span>
        <span class="c1"># You should implement it when you write your model for real.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="n">model_dir</span>
        <span class="c1"># Let&#39;s add a dict where we&#39;ll store what we know about previous records.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
<div class="section" id="train">
<h3>Train<a class="headerlink" href="#train" title="Permalink to this headline">¶</a></h3>
<p>This model predicts completely based on what features has seen as they map to a
classification.</p>
<p>As such, we’re going to take the JSON representation of each set of feature data
for each record we are given to train on, and hash it, storing the hash as the key
in our <code class="docutils literal notranslate"><span class="pre">self.mem</span></code> dict, and the value as the classification. This will let us
hash the feature data of future records we are asked to predict on and pull their
expected classification (for ones we’ve seen before).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">:</span> <span class="n">Sources</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Train using records as the data to learn from.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">sources</span><span class="o">.</span><span class="n">with_features</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
        <span class="c1"># Make sure we are only dealing with classifications we care about</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">classification</span><span class="p">()</span> <span class="ow">in</span> <span class="n">classifications</span><span class="p">:</span>
            <span class="c1"># Hash the data of the record and map it to the classification</span>
            <span class="n">as_json</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">features</span><span class="p">))</span>
            <span class="n">hash_json</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha384</span><span class="p">(</span><span class="n">as_json</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">[</span><span class="n">hash_json</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">classification</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="accuracy">
<h3>Accuracy<a class="headerlink" href="#accuracy" title="Permalink to this headline">¶</a></h3>
<p>You could implement this by passing <code class="docutils literal notranslate"><span class="pre">sources.classified_with_features(features)</span></code>
to predict and seeing how many it got right. However, we’re going to skip that
in this tutorial (because we know the accuracy of this demo model will suck).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">:</span> <span class="n">Sources</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Accuracy</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Evaluates the accuracy of our model after training using the input records</span>
<span class="sd">    as test data.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Lies</span>
    <span class="k">return</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
<div class="section" id="predict">
<h3>Predict<a class="headerlink" href="#predict" title="Permalink to this headline">¶</a></h3>
<p>The prediction, we’ll just need to hash the features of each record we’re asked to
make a prediction for. And see if it’s in the existing mapping. If not, then
we’ll just choose a random classification for it and call that good (with a 0%
confidence).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">:</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Record</span><span class="p">])</span> <span class="o">-&gt;</span> \
                <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Record</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Uses trained data to make a prediction about the quality of a record.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Pull all records which have the features we are interested in.</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="c1"># Hash the data of the record and map it to the classification</span>
        <span class="n">as_json</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">features</span><span class="p">()),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">hash_json</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha384</span><span class="p">(</span><span class="n">as_json</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="c1"># If the mapping exists then that&#39;s what we&#39;ll predict</span>
        <span class="k">if</span> <span class="n">hash_json</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">:</span>
            <span class="c1"># Send it back with 100% (1.0) confidence</span>
            <span class="k">yield</span> <span class="n">record</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="p">[</span><span class="n">hash_json</span><span class="p">],</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The feature hash doesn&#39;t exist in our mapping.</span>
            <span class="c1"># Pick a random classification and yield it with 0 confidence</span>
            <span class="k">yield</span> <span class="n">record</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">classifications</span><span class="p">),</span> <span class="mf">0.0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="correct-the-plugin-load-path">
<h2>Correct the plugin load path<a class="headerlink" href="#correct-the-plugin-load-path" title="Permalink to this headline">¶</a></h2>
<p>Since we changed the name from <code class="docutils literal notranslate"><span class="pre">misc</span></code> to <code class="docutils literal notranslate"><span class="pre">hindsight</span></code>, we have to change the path
in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> which will load our model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;dffml.model&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;hindsight = my_model.hindsight:Hindsight&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">},</span>
</pre></div>
</div>
</div>
<div class="section" id="test-the-new-model">
<h2>Test the new model<a class="headerlink" href="#test-the-new-model" title="Permalink to this headline">¶</a></h2>
<p>Lets modify the test case to verify that we did this right.</p>
<div class="section" id="change-the-import-path">
<h3>Change the import path<a class="headerlink" href="#change-the-import-path" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">my_model.hindsight</span> <span class="kn">import</span> <span class="n">Hindsight</span>
</pre></div>
</div>
</div>
<div class="section" id="change-the-class-name">
<h3>Change the class name<a class="headerlink" href="#change-the-class-name" title="Permalink to this headline">¶</a></h3>
<p>Change the test class’s name, and make sure <code class="docutils literal notranslate"><span class="pre">cls.model</span></code> is instantiating a
<code class="docutils literal notranslate"><span class="pre">Hindsight</span></code> model instead of the <code class="docutils literal notranslate"><span class="pre">Misc</span></code> model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestHindsight</span><span class="p">(</span><span class="n">AsyncTestCase</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
        <span class="c1"># Make sure to change the line below this from Misc to Hindsight!!!</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Hindsight</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">model_dir</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">feature</span> <span class="o">=</span> <span class="n">StartsWithA</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">Features</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">feature</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">classifications</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;not a&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="run-the-tests">
<h3>Run the tests<a class="headerlink" href="#run-the-tests" title="Permalink to this headline">¶</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> python3.7 setup.py <span class="nb">test</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="source.html" class="btn btn-neutral float-right" title="New Source Tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="operations.html" class="btn btn-neutral float-left" title="New Operations Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Intel

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>